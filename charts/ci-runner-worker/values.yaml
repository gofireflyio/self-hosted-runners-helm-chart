appName: ci-runner-worker
env: prod
namespace: iac-ci

# Deployment configuration
replicas: 3
useStatefulSet: false
autoReloadConfig: true

# Main container image
repository:
  name: ci-runner-worker
  registry: "public.ecr.aws/firefly/ci-runner-worker"
  tag: latest
  pullPolicy: IfNotPresent
  command: []
  args: []

# Docker-in-Docker sidecar
customImage:
  enabled: true
  name: docker
  repository: registry.hub.docker.com/library/docker
  tag: dind
  pullPolicy: IfNotPresent
  command: ["sh", "/usr/local/bin/dockerd-entrypoint.sh"]
  securityContext:
    privileged: true
    runAsUser: 0
  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 1000m
  env:
    - name: DOCKER_TLS_CERTDIR
      value: ""
    - name: DOCKER_HOST
      value: unix:///var/run/docker.sock

# Main container configuration
containers:
  securityContext:
    capabilities:
      add: ["NET_ADMIN"]
    runAsNonRoot: false

# Resources
resources:
  requests:
    memory: 512Mi
    cpu: 250m
  limits:
    memory: 1Gi
    cpu: 1000m

# Node scheduling
nodeSelector:
  karpenter.firefly.ai/arch: arm64

tolerations:
  - key: karpenter.firefly.ai/arch
    value: arm64
    effect: NoSchedule

affinity: {}

# Volumes
volumes:
  - name: docker-socket
    emptyDir: {}
  - name: workspaces
    emptyDir: {}

volumeMounts:
  - name: docker-socket
    mountPath: /var/run
  - name: workspaces
    mountPath: /workspace-data

# ConfigMap configuration
configMap:
  name: "ci-runner-worker"
  data:
    # Firefly configuration
    FIREFLY_API_URL: "https://api.firefly.ai"
    # Worker configuration
    WORKER_TEMPORAL_TLS: true
    WORKER_TEMPORAL_HOST_PORT: "temporal-api.firefly.ai:443"
    WORKER_ACCOUNT_ID: ""
    WORKER_POOL_ID: ""
    WORKER_DEBUG: 0
    # Workflow configuration
    WORKFLOW_WORKSPACE_BASE_PATH: "/workspace-data"
    WORKFLOW_TERRAFORM_ACTIVITY_TIMEOUT: "30m"
    # Terraform configuration
    TERRAFORM_IMAGE: "hashicorp/terraform"
    TERRAFORM_TAG: "latest"
    TERRAFORM_ACTIVITY_TIMEOUT: "30m"
    # OpenTofu configuration
    OPENTOFU_IMAGE: "ghcr.io/opentofu/opentofu"
    # Docker configuration
    DOCKER_HOST: "unix:///var/run/docker.sock"
    DOCKER_API_VERSION: ""
    # HTTP client configuration
    HTTP_RETRY_COUNT: "3"
    HTTP_RETRY_WAIT_TIME: "10s"
    HTTP_RETRY_MAX_WAIT: "30s"
    HTTP_TIMEOUT: "30s"
    # GIT configuration
    GIT_DEPTH: "5"
    # Github configuration
    GITHUB_MAX_RETRY_ATTEMPTS: "3"
    GITHUB_RETRY_TIMEOUT_BUFFER: "3s"
    GITHUB_RETRY_TIMEOUT: "60s"
    # CI Server configuration
    CI_AGENT_CI_SERVER_URL: "http://127.0.0.1:8080"
    CI_AGENT_IMAGE: "public.ecr.aws/firefly/fireflyci"
    CI_AGENT_TAG: "v0.5.147"
    # Metrics
    ENABLE_METRICS: 'true'
    METRICS_PORT: '3002'

# Secret configuration
secret:
  name: ci-runner-worker-secrets
  create: true
  data:
    FIREFLY_JWT_TOKEN: ""

secretConfigPointer:
  enabled: true
  secret: ci-runner-worker-secrets

# Service Account
serviceAccount:
  create: true
  name: ci-runner-worker
  annotations: {}

# Main Service
service:
  create: true
  customName: ci-runner-worker
  type: ClusterIP
  servicePort: 3001
  targetPort: 3001
  annotations: {}

# Metrics Service
metricsService:
  enabled: true
  servicePort: 3002
  targetPort: 3002
  annotations: {}

# Probes
livenessProbe:
  enabled: true
  httpGet:
    path: /health
    port: 3001
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /ready
    port: 3001
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 3

# ServiceMonitor for Prometheus
serviceMonitor:
  enabled: true
  namespace: ""
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
  honorLabels: true
  path: /metrics
  scheme: http

# KEDA autoscaling
keda:
  enabled: false
  minReplicaCount: 1
  maxReplicaCount: 10
  pollingInterval: 30
  cooldownPeriod: 300
  triggers: []