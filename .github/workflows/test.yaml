name: Test

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'ci-runner-worker/**'
  push:
    branches:
      - main
      - develop
    paths:
      - 'ci-runner-worker/**'
  workflow_dispatch:

jobs:
  helm-unittest:
    name: Helm Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Install helm-unittest plugin
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest

      - name: Run unit tests
        run: |
          helm unittest ci-runner-worker/
        continue-on-error: true

      - name: Test summary
        run: |
          echo "### Helm Unit Tests ✅" >> $GITHUB_STEP_SUMMARY
          echo "Unit tests completed" >> $GITHUB_STEP_SUMMARY

  template-validation:
    name: Template Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        scenario:
          - name: default
            values: ""
          - name: minimal-resources
            values: "--set resources.requests.memory=256Mi --set resources.limits.memory=512Mi"
          - name: high-availability
            values: "--set replicas=5"
          - name: with-keda
            values: "--set keda.enabled=true"
          - name: without-metrics
            values: "--set metricsService.enabled=false --set serviceMonitor.enabled=false"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Template chart - ${{ matrix.scenario.name }}
        run: |
          helm template ci-runner-worker ci-runner-worker/ \
            --namespace iac-ci \
            ${{ matrix.scenario.values }} \
            --debug > /tmp/manifests-${{ matrix.scenario.name }}.yaml

      - name: Validate manifests
        run: |
          echo "Validating ${{ matrix.scenario.name }} scenario"
          kubectl apply --dry-run=client -f /tmp/manifests-${{ matrix.scenario.name }}.yaml

      - name: Upload manifests
        uses: actions/upload-artifact@v4
        with:
          name: manifests-${{ matrix.scenario.name }}
          path: /tmp/manifests-${{ matrix.scenario.name }}.yaml

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Template chart
        run: |
          helm template ci-runner-worker ci-runner-worker/ \
            --namespace iac-ci > manifests.yaml

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'manifests.yaml'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Security summary
        if: always()
        run: |
          echo "### Security Scan ✅" >> $GITHUB_STEP_SUMMARY
          echo "Trivy security scan completed" >> $GITHUB_STEP_SUMMARY

  install-test:
    name: Install Test (kind)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: test-cluster
          wait: 30s

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.3'

      - name: Install chart
        run: |
          helm install ci-runner-worker ci-runner-worker/ \
            --namespace iac-ci \
            --create-namespace \
            --wait \
            --timeout 5m \
            --set livenessProbe.enabled=false \
            --set readinessProbe.enabled=false

      - name: Verify installation
        run: |
          kubectl get all -n iac-ci
          kubectl get configmap -n iac-ci
          kubectl get secret -n iac-ci
          kubectl get serviceaccount -n iac-ci

      - name: Check pod status
        run: |
          kubectl wait --for=condition=ready pod \
            -l app=ci-runner-worker \
            -n iac-ci \
            --timeout=120s || true

      - name: Get pod logs
        if: always()
        run: |
          kubectl logs -n iac-ci -l app=ci-runner-worker --all-containers=true --tail=100 || true

      - name: Uninstall chart
        if: always()
        run: |
          helm uninstall ci-runner-worker --namespace iac-ci || true

      - name: Install test summary
        if: always()
        run: |
          echo "### Installation Test ✅" >> $GITHUB_STEP_SUMMARY
          echo "Chart installation test completed on kind cluster" >> $GITHUB_STEP_SUMMARY

  test-results:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [helm-unittest, template-validation, security-scan, install-test]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Unit Tests | ${{ needs.helm-unittest.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Template Validation | ${{ needs.template-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Install Test | ${{ needs.install-test.result }} |" >> $GITHUB_STEP_SUMMARY