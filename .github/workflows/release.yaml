name: Release Helm Charts

# Do not change this
concurrency: release-helm

on:
  workflow_dispatch:
    inputs:
      include_previous_versions:
        description: 'Include previous versions (number of versions to include)'
        required: false
        default: '3'
        type: string
      specific_versions:
        description: 'Specific versions to build (comma-separated, e.g. 0.0.102,0.0.103)'
        required: false
        default: ''
        type: string
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v1

      - name: Extract Chart Info
        id: chart-info
        shell: bash
        run: |
          # Extract version and name from ci-runner-worker Chart.yaml
          CI_RUNNER_WORKER_VERSION=$(grep 'version:' "charts/ci-runner-worker/Chart.yaml" | awk '{print $2}')
          CI_RUNNER_WORKER_NAME=$(grep 'name:' "charts/ci-runner-worker/Chart.yaml" | awk '{print $2}')
          echo "Using chart version: $CI_RUNNER_WORKER_VERSION"
          echo "ci-runner-worker_version=$CI_RUNNER_WORKER_VERSION" >> $GITHUB_OUTPUT
          echo "ci-runner-worker_name=$CI_RUNNER_WORKER_NAME" >> $GITHUB_OUTPUT

      - name: Package Helm Charts
        id: package
        shell: bash
        run: |
          # Get workspace absolute path
          WORKSPACE=$(pwd)
          
          # Create directory for packaged charts
          mkdir -p "$WORKSPACE/packaged-charts"
          
          # Update dependencies and package charts
          find charts/ -type f -name 'Chart.yaml' | sed -r 's|/[^/]+$||' | sort | uniq | xargs -L 1 helm dep up
          
          # Package and list all chart files for future steps
          echo "chart_files=" >> $GITHUB_OUTPUT
          for d in charts/*/ ; do
            echo "Packaging $d"
          
            # Ensure packaged-charts directory exists
            mkdir -p "$WORKSPACE/packaged-charts"
          
            helm package "$d" -u -d "$WORKSPACE/packaged-charts"
          
            # Get the name of the packaged file
            CHART_NAME=$(basename "$d")
            CHART_VERSION=$(grep 'version:' "${d}Chart.yaml" | awk '{print $2}')
            CHART_FILENAME="${CHART_NAME}-${CHART_VERSION}.tgz"
          
            echo "Created: $WORKSPACE/packaged-charts/$CHART_FILENAME"
          
            # Append to the output list
            echo "chart_files+=$CHART_FILENAME," >> $GITHUB_OUTPUT
          done

      - name: Package Previous Chart Versions
        id: package_previous
        shell: bash
        run: |
          # Create directory for packaged charts if it doesn't exist
          mkdir -p packaged-charts
          
          # Get a list of the last X version tags (excluding the current one)
          CURRENT_TAG="ci-runner-worker-${{ steps.chart-info.outputs.ci-runner-worker_version }}"
          NUM_VERSIONS="${{ github.event.inputs.include_previous_versions || '3' }}"
          
          # Check if specific versions were provided
          if [ -n "${{ github.event.inputs.specific_versions }}" ]; then
            echo "Building specific versions: ${{ github.event.inputs.specific_versions }}"
            SPECIFIC_VERSIONS="${{ github.event.inputs.specific_versions }}"
          
            # Save current state
            git stash -u
          
            # Process each specific version
            IFS=',' read -ra VERSIONS <<< "$SPECIFIC_VERSIONS"
            for VERSION in "${VERSIONS[@]}"; do
              VERSION=$(echo "$VERSION" | tr -d ' ')
              TAG="ci-runner-worker-$VERSION"
          
              echo "Building specific version: $VERSION (tag: $TAG)"
          
              # Check if this version is already in packaged-charts
              if [ -f "packaged-charts/ci-runner-worker-$VERSION.tgz" ]; then
                echo "Chart version $VERSION already exists in packaged-charts, skipping"
                continue
              fi
          
              # Check if the tag exists
              if git rev-parse --verify "$TAG" >/dev/null 2>&1; then
                # Checkout the tag
                git checkout $TAG
          
                # Check if the chart exists at this tag
                if [ -d "charts/ci-runner-worker" ]; then
                  echo "Building chart version $VERSION"
          
                  # Debug information
                  pwd
                  ls -la
                  ls -la charts/
          
                  # Ensure packaged-charts directory exists with absolute path
                  WORKSPACE=$(pwd)
                  mkdir -p "$WORKSPACE/packaged-charts"
          
                  # Build the chart with absolute path
                  helm package "charts/ci-runner-worker" -u -d "$WORKSPACE/packaged-charts"
          
                  # Append to chart_files output
                  echo "chart_files+=ci-runner-worker-$VERSION.tgz," >> $GITHUB_OUTPUT
                else
                  echo "Warning: charts/ci-runner-worker directory not found in tag $TAG"
                fi
              else
                echo "Tag $TAG doesn't exist, creating artificial version"
          
                # Return to the original branch to use as ci-runner-worker
                git checkout -
          
                # Create temporary directory with modified Chart.yaml
                mkdir -p temp-chart
                cp -r charts/ci-runner-worker/* temp-chart/
          
                # Update version in Chart.yaml
                sed -i "s/^version:.*/version: $VERSION/" temp-chart/Chart.yaml
          
                # Ensure packaged-charts directory exists with absolute path
                WORKSPACE=$(pwd)
                mkdir -p "$WORKSPACE/packaged-charts"
          
                # Package the chart with absolute path
                helm package "temp-chart" -u -d "$WORKSPACE/packaged-charts"
          
                # Append to chart_files output
                echo "chart_files+=ci-runner-worker-$VERSION.tgz," >> $GITHUB_OUTPUT
          
                # Clean up
                rm -rf temp-chart
              fi
            done
          else
            # Get previous versions automatically
            PREVIOUS_TAGS=$(git tag -l "ci-runner-worker-*" | grep -v "$CURRENT_TAG" | sort -Vr | head -$NUM_VERSIONS)
          
            echo "Building previous chart versions: $PREVIOUS_TAGS"
          
            # Save current state
            git stash -u
          
            for TAG in $PREVIOUS_TAGS; do
              echo "Building version from tag: $TAG"
          
              # Extract version number from tag
              VERSION=${TAG#ci-runner-worker-}
          
              # Check if this version is already in packaged-charts
              if [ -f "packaged-charts/ci-runner-worker-$VERSION.tgz" ]; then
                echo "Chart version $VERSION already exists in packaged-charts, skipping"
                continue
              fi
          
              # Checkout the tag
              git checkout $TAG
          
              # Check if the chart exists at this tag
              if [ -d "charts/ci-runner-worker" ]; then
                echo "Building chart version $VERSION"
          
                # Debug information
                pwd
                ls -la
                ls -la charts/
          
                # Ensure packaged-charts directory exists with absolute path
                WORKSPACE=$(pwd)
                mkdir -p "$WORKSPACE/packaged-charts"
          
                # Build the chart with absolute path
                helm package "charts/ci-runner-worker" -u -d "$WORKSPACE/packaged-charts"
          
                # Append to chart_files output
                echo "chart_files+=ci-runner-worker-$VERSION.tgz," >> $GITHUB_OUTPUT
              else
                echo "Warning: charts/ci-runner-worker directory not found in tag $TAG"
              fi
            done
          fi
          
          # Return to the original branch
          git checkout -
          git stash pop || true
          
          echo "All previous chart versions packaged:"
          ls -la packaged-charts/

      - name: Check if tag exists
        id: check_tag
        run: |
          TAG_NAME="ci-runner-worker-${{ steps.chart-info.outputs.ci-runner-worker_version }}"
          git fetch --tags
          if git tag -l "$TAG_NAME" | grep -q "$TAG_NAME"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG_NAME does not exist"
          fi

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        if: steps.check_tag.outputs.exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ci-runner-worker-${{ steps.chart-info.outputs.ci-runner-worker_version }}
          release_name: ${{ steps.chart-info.outputs.ci-runner-worker_name }}-${{ steps.chart-info.outputs.ci-runner-worker_version }}
          draft: false
          prerelease: false

      - name: Get existing release
        id: get_release
        if: steps.check_tag.outputs.exists == 'true'
        run: |
          TAG_NAME="ci-runner-worker-${{ steps.chart-info.outputs.ci-runner-worker_version }}"
          RELEASE_INFO=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME")
          
          RELEASE_ID=$(echo "$RELEASE_INFO" | jq -r '.id')
          
          # Get the proper upload URL format that the upload-release-asset action expects
          UPLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.upload_url')
          
          # Debugging: Show the raw upload URL
          echo "Raw upload URL: $UPLOAD_URL"
          
          # Check if the upload URL is valid
          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" = "null" ]; then
            echo "Error: Failed to get upload URL for release with tag $TAG_NAME"
            echo "Release info: $RELEASE_INFO"
            exit 1
          fi
          
          echo "Found existing release with ID: $RELEASE_ID"
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT

      - name: Upload Base Chart
        id: upload_ci-runner-worker
        run: |
          # Get workspace absolute path
          WORKSPACE=$(pwd)
          
          ASSET_NAME="${{ steps.chart-info.outputs.ci-runner-worker_name }}-${{ steps.chart-info.outputs.ci-runner-worker_version }}.tgz"
          ASSET_PATH="$WORKSPACE/packaged-charts/$ASSET_NAME"
          
          # Check if file exists
          if [ ! -f "$ASSET_PATH" ]; then
            echo "ERROR: Asset file does not exist: $ASSET_PATH"
            ls -la "$WORKSPACE/packaged-charts/"
            exit 1
          fi
          
          if [ "${{ steps.check_tag.outputs.exists }}" == "true" ]; then
            # Use existing release upload URL
            UPLOAD_URL="${{ steps.get_release.outputs.upload_url }}"
          
            # Check if the asset already exists in the release
            TAG_NAME="ci-runner-worker-${{ steps.chart-info.outputs.ci-runner-worker_version }}"
            RELEASE_INFO=$(curl -s \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME")
          
            ASSET_EXISTS=$(echo "$RELEASE_INFO" | jq -r '.assets | map(select(.name=="'$ASSET_NAME'")) | length')
          
            if [ "$ASSET_EXISTS" -gt "0" ]; then
              echo "Asset $ASSET_NAME already exists in the release. Skipping upload."
              DOWNLOAD_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name=="'$ASSET_NAME'") | .browser_download_url')
              echo "direct_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            # Use newly created release upload URL
            UPLOAD_URL="${{ steps.create_release.outputs.upload_url }}"
          fi
          
          # Extract ci-runner-worker URL without the template part
          UPLOAD_URL_CI_RUNNER_WORKER="${UPLOAD_URL%\{*}"
          
          echo "Uploading $ASSET_NAME to $UPLOAD_URL_CI_RUNNER_WORKER?name=$ASSET_NAME"
          
          # Upload the asset
          UPLOAD_RESPONSE=$(curl -s \
            -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/x-gtar" \
            --data-binary "@$ASSET_PATH" \
            "$UPLOAD_URL_CI_RUNNER_WORKER?name=$ASSET_NAME")
          
          # Check for errors and get the browser download URL
          DOWNLOAD_URL=$(echo "$UPLOAD_RESPONSE" | jq -r '.browser_download_url')
          
          if [ "$DOWNLOAD_URL" == "null" ]; then
            echo "ERROR: Failed to upload asset. Response:"
            echo "$UPLOAD_RESPONSE" | jq .
            exit 1
          else
            echo "Successfully uploaded asset. Download URL: $DOWNLOAD_URL"
            echo "direct_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          fi

      - name: Verify Release
        run: |
          TAG_NAME="ci-runner-worker-${{ steps.chart-info.outputs.ci-runner-worker_version }}"
          ASSET_NAME="${{ steps.chart-info.outputs.ci-runner-worker_name }}-${{ steps.chart-info.outputs.ci-runner-worker_version }}.tgz"
          
          # Get the release info
          RELEASE_INFO=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG_NAME")
          
          # Check if release exists
          RELEASE_ID=$(echo "$RELEASE_INFO" | jq -r '.id')
          if [ "$RELEASE_ID" == "null" ]; then
            echo "ERROR: Release with tag $TAG_NAME not found"
            exit 1
          fi
          
          echo "Release found with ID: $RELEASE_ID"
          
          # Get the assets
          ASSETS=$(echo "$RELEASE_INFO" | jq -r '.assets')
          ASSET_COUNT=$(echo "$ASSETS" | jq -r 'length')
          
          echo "Release has $ASSET_COUNT assets"
          
          # Check if our asset exists
          ASSET_URL=$(echo "$ASSETS" | jq -r '.[] | select(.name=="'$ASSET_NAME'") | .browser_download_url')
          
          if [ -z "$ASSET_URL" ]; then
            echo "ERROR: Asset $ASSET_NAME not found in release"
            echo "Available assets:"
            echo "$ASSETS" | jq -r '.[] | .name'
            exit 1
          fi
          
          echo "Asset found at URL: $ASSET_URL"
          echo "You can download it with:"
          echo "helm pull $ASSET_URL"
          echo ""
          echo "Or with credentials:"
          echo "helm pull --username USERNAME --password TOKEN $ASSET_URL"
          
          # Also verify with a HEAD request that the file is accessible
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -I "$ASSET_URL")
          
          if [ "$HTTP_STATUS" == "200" ]; then
            echo "Asset is accessible (HTTP 200)"
          else
            echo "WARNING: Asset is not accessible (HTTP $HTTP_STATUS)"
            echo "This may be due to repository visibility settings or token requirements"
          fi

      - name: Generate Helm Repository
        run: |
          # Get workspace absolute path
          WORKSPACE=$(pwd)
          
          # Create and organize repo directory
          mkdir -p "$WORKSPACE/helm-repo"
          
          # Try to fetch existing index.yaml to preserve version history
          curl -s -o "$WORKSPACE/existing-index.yaml" "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/index.yaml" || true
          
          # Copy new chart packages
          cp "$WORKSPACE/packaged-charts"/*.tgz "$WORKSPACE/helm-repo/"
          
          # Try to download previous chart packages that might be missing
          if [ -f "$WORKSPACE/existing-index.yaml" ] && [ -s "$WORKSPACE/existing-index.yaml" ]; then
            echo "Downloading existing chart packages from repository to ensure all versions are preserved"
            mkdir -p "$WORKSPACE/downloaded-charts"
          
            # Extract URLs from existing index.yaml
            grep "    urls:" "$WORKSPACE/existing-index.yaml" | sed 's/    urls://' | tr -d '[]"' | tr -d ' ' | tr ',' '\n' > chart_urls.txt
          
            # Download each chart
            while read -r url; do
              if [[ "$url" == http* ]]; then
                echo "Downloading: $url"
                filename=$(ci-runner-workername "$url")
                if [ ! -f "$WORKSPACE/packaged-charts/$filename" ]; then
                  curl -s -L -o "$WORKSPACE/downloaded-charts/$filename" "$url" || true
                  if [ -f "$WORKSPACE/downloaded-charts/$filename" ]; then
                    cp "$WORKSPACE/downloaded-charts/$filename" "$WORKSPACE/helm-repo/"
                    echo "Downloaded and copied: $filename"
                  fi
                else
                  echo "Skip downloading, using local file: $filename"
                fi
              fi
            done < chart_urls.txt
          fi
          
          # Generate index.yaml for Helm repository, merging with existing if available
          cd "$WORKSPACE/helm-repo"
          if [ -f "../existing-index.yaml" ] && [ -s "../existing-index.yaml" ]; then
            echo "Merging with existing index.yaml to preserve version history"
            helm repo index --merge ../existing-index.yaml .
          else
            echo "Creating new index.yaml (no existing index found or empty)"
            helm repo index .
          fi
          
          # Print the index file for debugging
          cat index.yaml

      - name: Deploy Helm Repository to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./helm-repo
          publish_branch: gh-pages

      - name: Verify GitHub Pages Deployment
        run: |
          # Wait for GitHub Pages to deploy (can take a minute)
          echo "Waiting for GitHub Pages deployment to complete..."
          sleep 60
          
          # Check if index.yaml is accessible
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/index.yaml")
          
          echo "GitHub Pages status code: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq "200" ]; then
            echo "GitHub Pages deployment successful! Helm repository is available at:"
            echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          else
            echo "WARNING: GitHub Pages deployment may not be complete yet."
            echo "Please check https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/index.yaml manually."
            echo "If the issue persists, ensure GitHub Pages is enabled in repository settings."
          fi

      - name: Create Version Branch
        run: |
          # Get workspace absolute path
          WORKSPACE=$(pwd)
          
          # Create a branch ci-runner-workerd on the ci-runner-worker chart version
          VERSION_BRANCH="ci-runner-worker-${{ steps.chart-info.outputs.ci-runner-worker_version }}"
          
          # Create a new directory for the version branch
          mkdir -p "$WORKSPACE/version-branch"
          cd "$WORKSPACE/version-branch"
          
          # Initialize git repo
          git init
          git config user.name "Helm Updater"
          git config user.email "actions@users.noreply.github.com"
          
          # Copy helm repo contents
          cp -r "$WORKSPACE/helm-repo/"* .
          
          # Add and commit
          git add .
          git commit -m "Release version ${{ steps.chart-info.outputs.ci-runner-worker_version }}"
          
          # Add remote and push
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Create or update the version branch, force pushing as it's a generated branch
          git push --force origin HEAD:refs/heads/$VERSION_BRANCH
          
          echo "Helm repository also available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "To add this Helm repository:"
          echo "helm repo add ${{ github.event.repository.name }} https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          echo "helm repo update"
